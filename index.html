<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CINEMATIC CHOIR ORCHESTRA v11</title>
<style>
:root {
    --primary: #C47E2C;
    --primary-dark: #9C5E1C;
    --secondary: #2a5c8c;
    --secondary-dark: #1a4c7c;
    --bg-dark: #0a0a0a;
    --bg-panel: #1a1a1a;
    --bg-elevated: #2a2a2a;
    --text: #ffffff;
    --text-muted: #aaaaaa;
    --success: #4CAF50;
    --warning: #FF9800;
    --danger: #F44336;
    --border: #333333;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 100%);
    color: var(--text);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
    min-height: 100vh;
    padding: 20px;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
}

.header {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
}

.header h1 {
    font-size: 2.5rem;
    background: linear-gradient(135deg, var(--primary), #e6b851);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 10px;
}

.subtitle {
    color: var(--text-muted);
    font-size: 1.1rem;
}

.panel {
    background: var(--bg-panel);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid rgba(196, 126, 44, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.panel h2 {
    color: var(--primary);
    margin-bottom: 20px;
    font-size: 1.5rem;
}

.tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 10px;
}

.tab {
    padding: 10px 20px;
    background: transparent;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    border-radius: 5px;
    transition: all 0.3s;
}

.tab:hover {
    background: rgba(196, 126, 44, 0.1);
}

.tab.active {
    background: var(--primary);
    color: white;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.upload-area {
    border: 3px dashed var(--border);
    border-radius: 10px;
    padding: 40px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    margin-bottom: 20px;
}

.upload-area:hover {
    border-color: var(--primary);
    background: rgba(196, 126, 44, 0.05);
}

.upload-area i {
    font-size: 48px;
    margin-bottom: 15px;
    color: var(--primary);
}

.upload-area h3 {
    margin-bottom: 10px;
    color: var(--text);
}

.upload-area p {
    color: var(--text-muted);
    margin-bottom: 15px;
}

.file-info {
    background: var(--bg-elevated);
    border-radius: 10px;
    padding: 20px;
    margin-top: 20px;
}

.info-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border);
}

.info-row:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.info-label {
    color: var(--text-muted);
}

.info-value {
    color: var(--text);
    font-weight: bold;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
}

.btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(196, 126, 44, 0.4);
}

.btn-secondary {
    background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
    color: white;
}

.btn-success {
    background: linear-gradient(135deg, var(--success), #388E3C);
    color: white;
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
}

.controls {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 20px;
}

.status {
    background: var(--bg-elevated);
    border-radius: 10px;
    padding: 15px;
    margin-top: 20px;
}

.status-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
}

.status-label {
    color: var(--text-muted);
}

.status-value {
    color: var(--text);
    font-weight: bold;
}

.progress {
    margin-top: 20px;
}

.progress-bar {
    height: 6px;
    background: var(--border);
    border-radius: 3px;
    overflow: hidden;
    margin-top: 5px;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--secondary), var(--primary));
    width: 0%;
    transition: width 0.3s;
}

.message {
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    display: none;
}

.message.success {
    background: rgba(76, 175, 80, 0.1);
    border-left: 4px solid var(--success);
    color: var(--success);
    display: block;
}

.message.error {
    background: rgba(244, 67, 54, 0.1);
    border-left: 4px solid var(--danger);
    color: var(--danger);
    display: block;
}

.message.warning {
    background: rgba(255, 152, 0, 0.1);
    border-left: 4px solid var(--warning);
    color: var(--warning);
    display: block;
}

.grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 25px;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    margin-bottom: 8px;
    color: var(--text-muted);
}

.slider-container {
    margin-top: 10px;
}

input[type="range"] {
    width: 100%;
    height: 6px;
    background: var(--border);
    border-radius: 3px;
    outline: none;
    -webkit-appearance: none;
}

input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--primary);
    cursor: pointer;
    border: 3px solid var(--bg-dark);
}

select, input[type="text"] {
    width: 100%;
    padding: 12px;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 14px;
}

@media (max-width: 768px) {
    .grid {
        grid-template-columns: 1fr;
    }
    
    .controls {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
    }
}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üéµ CINEMATIC CHOIR ORCHESTRA v11</h1>
        <p class="subtitle">Transform vocals into epic cinematic harmonies</p>
    </div>

    <div class="grid">
        <!-- INPUT SECTION -->
        <div class="panel">
            <h2>üé§ INPUT SOURCE</h2>
            
            <div class="tabs">
                <button class="tab active" data-tab="mic">Microphone</button>
                <button class="tab" data-tab="file">Audio File</button>
            </div>
            
            <!-- Microphone Tab -->
            <div class="tab-content active" id="micTab">
                <p style="margin-bottom: 20px; color: var(--text-muted);">
                    Use your microphone for real-time processing
                </p>
                <button class="btn btn-primary" id="micBtn" style="width: 100%; padding: 15px;">
                    üé§ ACTIVATE MICROPHONE
                </button>
                <div class="status">
                    <div class="status-row">
                        <span class="status-label">Microphone Status:</span>
                        <span class="status-value" id="micStatus">Inactive</span>
                    </div>
                </div>
            </div>
            
            <!-- File Upload Tab -->
            <div class="tab-content" id="fileTab">
                <p style="margin-bottom: 20px; color: var(--text-muted);">
                    Upload any audio file (WAV, MP3, M4A, OGG, FLAC, etc.)
                </p>
                
                <div class="upload-area" id="uploadArea">
                    <i>üìÅ</i>
                    <h3>Drop audio file here or click to browse</h3>
                    <p>Supports: WAV, MP3, M4A, OGG, FLAC, AAC, AIFF</p>
                    <input type="file" id="audioFile" accept="audio/*" style="display: none;">
                </div>
                
                <div class="message" id="uploadMessage"></div>
                
                <div class="file-info" id="fileInfo" style="display: none;">
                    <div class="info-row">
                        <span class="info-label">File:</span>
                        <span class="info-value" id="fileName">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Duration:</span>
                        <span class="info-value" id="fileDuration">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Format:</span>
                        <span class="info-value" id="fileFormat">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Size:</span>
                        <span class="info-value" id="fileSize">-</span>
                    </div>
                    <div class="progress">
                        <div class="info-row">
                            <span class="info-label">Loading:</span>
                            <span class="info-value" id="loadPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="loadProgress"></div>
                        </div>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn btn-secondary" id="playFileBtn" disabled>‚ñ∂ Play</button>
                    <button class="btn btn-secondary" id="pauseFileBtn" disabled>‚è∏ Pause</button>
                    <button class="btn btn-secondary" id="stopFileBtn" disabled>‚èπ Stop</button>
                    <button class="btn btn-secondary" id="loopFileBtn" disabled>‚Üª Loop</button>
                </div>
            </div>
            
            <div class="status" style="margin-top: 25px;">
                <div class="status-row">
                    <span class="status-label">System Status:</span>
                    <span class="status-value" id="systemStatus">Ready</span>
                </div>
            </div>
        </div>

        <!-- SETTINGS SECTION -->
        <div class="panel">
            <h2>üéπ CHOIR SETTINGS</h2>
            
            <div class="form-group">
                <label class="form-label">
                    <span>Octave Layers: <strong id="octavesText">3</strong></span>
                </label>
                <div class="slider-container">
                    <input type="range" id="octaves" min="1" max="6" value="3" step="1">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <span>Voices per Layer: <strong id="voicesText">6</strong></span>
                </label>
                <div class="slider-container">
                    <input type="range" id="voices" min="2" max="12" value="6" step="1">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Harmony Preset</label>
                <select id="preset" class="form-control">
                    <option value="gospel">Gospel Choir (7th chords)</option>
                    <option value="cinematic">Cinematic (suspensions)</option>
                    <option value="angelic">Angelic Air (4ths & 5ths)</option>
                    <option value="octaves">Octave Stack</option>
                    <option value="unison">Wide Unison</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Key (Auto-Tune)</label>
                <select id="key" class="form-control">
                    <option value="C">C Major</option>
                    <option value="Cm">C Minor</option>
                    <option value="D">D Major</option>
                    <option value="Dm">D Minor</option>
                    <option value="E">E Major</option>
                    <option value="Em">E Minor</option>
                    <option value="F">F Major</option>
                    <option value="Fm">F Minor</option>
                    <option value="G">G Major</option>
                    <option value="Gm">G Minor</option>
                    <option value="A">A Major</option>
                    <option value="Am">A Minor</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Custom Intervals (semitones, comma separated)</label>
                <input type="text" id="customIntervals" value="0,4,7,12" placeholder="0,4,7,12">
            </div>
        </div>

        <!-- PROCESSING SECTION -->
        <div class="panel">
            <h2>‚ö° PROCESSING</h2>
            
            <div class="controls">
                <button class="btn btn-primary" id="startChoirBtn" disabled style="flex: 1;">
                    üéµ START CHOIR PROCESSING
                </button>
                <button class="btn btn-danger" id="stopChoirBtn" disabled>
                    ‚èπ STOP
                </button>
            </div>
            
            <div class="status" style="margin-top: 20px;">
                <div class="status-row">
                    <span class="status-label">Active Voices:</span>
                    <span class="status-value" id="activeVoices">0</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Processing Status:</span>
                    <span class="status-value" id="processingStatus">Idle</span>
                </div>
                <div class="status-row">
                    <span class="status-label">CPU Load:</span>
                    <span class="status-value" id="cpuLoad">0%</span>
                </div>
            </div>
            
            <h3 style="margin-top: 25px; color: var(--primary);">üíæ EXPORT</h3>
            
            <div class="controls" style="margin-top: 15px;">
                <button class="btn btn-secondary" id="recordBtn" disabled>‚è∫ Record Live</button>
                <button class="btn btn-secondary" id="renderBtn" disabled>‚ö° Render File</button>
                <button class="btn btn-success" id="previewBtn" disabled>üéß Preview</button>
                <button class="btn btn-primary" id="downloadBtn" disabled>‚¨á Download</button>
            </div>
            
            <div class="progress" id="renderProgress" style="display: none; margin-top: 20px;">
                <div class="info-row">
                    <span class="info-label">Rendering:</span>
                    <span class="info-value" id="renderPercent">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="renderFill"></div>
                </div>
            </div>
            
            <div class="message" id="exportMessage"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.js"></script>
<script>
// ======= VARIABLES =======
let micStream = null;
let audioInput = null;
let audioBuffer = null;
let processedAudioBuffer = null;
let masterGain, reverbNode;
let choirLayers = [];
let mediaRecorder, recordedChunks = [];
let analyser;
let isChoirRunning = false;
let animationFrameId = null;
let currentInputType = 'mic';
let audioElement = null;
let isFileLooping = false;

// ======= UI INITIALIZATION =======
document.addEventListener('DOMContentLoaded', function() {
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabId = this.dataset.tab;
            
            // Update active tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Show corresponding content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId + 'Tab').classList.add('active');
            
            // Update current input type
            currentInputType = tabId;
            
            // Update button state
            updateStartButtonState();
        });
    });

    // File upload area click
    document.getElementById('uploadArea').addEventListener('click', function() {
        document.getElementById('audioFile').click();
    });

    // File input change
    document.getElementById('audioFile').addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            handleFileUpload(e.target.files[0]);
        }
    });

    // Drag and drop
    const uploadArea = document.getElementById('uploadArea');
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.style.borderColor = '#C47E2C';
        this.style.background = 'rgba(196, 126, 44, 0.05)';
    });

    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.style.borderColor = '#333';
        this.style.background = 'transparent';
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        this.style.borderColor = '#333';
        this.style.background = 'transparent';
        
        if (e.dataTransfer.files.length > 0) {
            const file = e.dataTransfer.files[0];
            if (file.type.startsWith('audio/')) {
                handleFileUpload(file);
            } else {
                showMessage('Please drop an audio file', 'error');
            }
        }
    });

    // Bind slider updates
    document.getElementById('octaves').addEventListener('input', function() {
        document.getElementById('octavesText').textContent = this.value;
    });

    document.getElementById('voices').addEventListener('input', function() {
        document.getElementById('voicesText').textContent = this.value;
    });

    // File playback controls
    document.getElementById('playFileBtn').addEventListener('click', togglePlayback);
    document.getElementById('pauseFileBtn').addEventListener('click', pausePlayback);
    document.getElementById('stopFileBtn').addEventListener('click', stopPlayback);
    document.getElementById('loopFileBtn').addEventListener('click', toggleLoop);

    // Initialize
    updateStartButtonState();
});

// ======= FILE UPLOAD HANDLER =======
async function handleFileUpload(file) {
    const messageEl = document.getElementById('uploadMessage');
    const fileInfoEl = document.getElementById('fileInfo');
    const loadProgress = document.getElementById('loadProgress');
    const loadPercent = document.getElementById('loadPercent');
    
    // Reset
    showMessage('Loading audio file...', 'warning');
    fileInfoEl.style.display = 'none';
    audioBuffer = null;
    
    // Validate file
    if (!file.type.startsWith('audio/')) {
        showMessage('Please select an audio file', 'error');
        return;
    }
    
    // File size check (50MB limit)
    if (file.size > 50 * 1024 * 1024) {
        showMessage('File too large (max 50MB)', 'error');
        return;
    }
    
    try {
        // Show file info
        fileInfoEl.style.display = 'block';
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = formatFileSize(file.size);
        document.getElementById('fileFormat').textContent = file.type.split('/')[1].toUpperCase();
        
        // Update progress
        loadProgress.style.width = '30%';
        loadPercent.textContent = '30%';
        
        // Create audio context
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // Read file
        const arrayBuffer = await file.arrayBuffer();
        loadProgress.style.width = '60%';
        loadPercent.textContent = '60%';
        
        // Decode audio
        audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
        
        // Update info
        document.getElementById('fileDuration').textContent = formatTime(audioBuffer.duration);
        loadProgress.style.width = '100%';
        loadPercent.textContent = '100%';
        
        // Enable controls
        document.getElementById('playFileBtn').disabled = false;
        document.getElementById('pauseFileBtn').disabled = false;
        document.getElementById('stopFileBtn').disabled = false;
        document.getElementById('loopFileBtn').disabled = false;
        document.getElementById('renderBtn').disabled = false;
        
        showMessage('‚úÖ File loaded successfully! Ready for processing.', 'success');
        
        // Switch to file tab if not already
        const fileTab = document.querySelector('[data-tab="file"]');
        if (!fileTab.classList.contains('active')) {
            fileTab.click();
        }
        
        // Update start button
        updateStartButtonState();
        
        // Close audio context to save resources
        await audioContext.close();
        
    } catch (error) {
        console.error('Error loading audio:', error);
        showMessage(`‚ùå Error loading audio: ${error.message}`, 'error');
        fileInfoEl.style.display = 'none';
        audioBuffer = null;
    }
}

// ======= AUDIO PLAYBACK CONTROLS =======
function togglePlayback() {
    if (!audioBuffer) return;
    
    if (audioElement && !audioElement.paused) {
        audioElement.pause();
        this.textContent = '‚ñ∂ Play';
    } else {
        if (!audioElement) {
            // Create audio element from buffer
            const audioContext = new AudioContext();
            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioContext.destination);
            source.start();
            audioElement = source;
            
            audioElement.onended = () => {
                if (isFileLooping) {
                    togglePlayback();
                }
            };
        } else {
            // Resume playback
            const audioContext = new AudioContext();
            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioContext.destination);
            source.start();
            audioElement = source;
        }
        this.textContent = '‚è∏ Pause';
    }
}

function pausePlayback() {
    if (audioElement) {
        audioElement.stop();
        document.getElementById('playFileBtn').textContent = '‚ñ∂ Play';
    }
}

function stopPlayback() {
    if (audioElement) {
        audioElement.stop();
        audioElement = null;
        document.getElementById('playFileBtn').textContent = '‚ñ∂ Play';
    }
}

function toggleLoop() {
    isFileLooping = !isFileLooping;
    this.textContent = isFileLooping ? '‚Üª Looping' : '‚Üª Loop';
}

// ======= MICROPHONE HANDLING =======
document.getElementById('micBtn').addEventListener('click', async function() {
    if (micStream) {
        // Stop microphone
        micStream.getTracks().forEach(track => track.stop());
        micStream = null;
        this.textContent = 'üé§ ACTIVATE MICROPHONE';
        document.getElementById('micStatus').textContent = 'Inactive';
        showMessage('Microphone deactivated', 'warning');
        updateStartButtonState();
        return;
    }
    
    try {
        micStream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
                echoCancellation: false,
                noiseSuppression: false,
                autoGainControl: false,
                channelCount: 1
            } 
        });
        
        this.textContent = 'üé§ MICROPHONE ACTIVE';
        document.getElementById('micStatus').textContent = 'Active';
        showMessage('Microphone activated successfully!', 'success');
        
        // Switch to mic tab if not already
        const micTab = document.querySelector('[data-tab="mic"]');
        if (!micTab.classList.contains('active')) {
            micTab.click();
        }
        
        updateStartButtonState();
        
    } catch (error) {
        showMessage(`Failed to access microphone: ${error.message}`, 'error');
        document.getElementById('micStatus').textContent = 'Error';
    }
});

// ======= CHOIR PROCESSING =======
document.getElementById('startChoirBtn').addEventListener('click', async function() {
    if (currentInputType === 'mic' && !micStream) {
        showMessage('Please activate microphone first', 'error');
        return;
    }
    
    if (currentInputType === 'file' && !audioBuffer) {
        showMessage('Please load an audio file first', 'error');
        return;
    }
    
    // Initialize Tone.js
    await Tone.start();
    Tone.context.resume();
    
    // Get parameters
    const octaves = parseInt(document.getElementById('octaves').value);
    const voices = parseInt(document.getElementById('voices').value);
    const preset = document.getElementById('preset').value;
    const key = document.getElementById('key').value;
    const customIntervals = document.getElementById('customIntervals').value;
    
    // Clear previous choir
    if (choirLayers.length > 0) {
        choirLayers.forEach(layer => {
            layer.forEach(voice => {
                voice.disconnect();
            });
        });
        choirLayers = [];
    }
    
    // Setup audio chain
    masterGain = new Tone.Gain(0.7).toDestination();
    reverbNode = new Tone.Reverb({
        decay: 3,
        wet: 0.6
    }).connect(masterGain);
    
    // Create input based on type
    if (currentInputType === 'mic') {
        audioInput = new Tone.UserMedia();
        await audioInput.open(micStream);
    } else {
        // Create Tone.Player from buffer
        const player = new Tone.Player({
            url: audioBuffer,
            loop: true,
            autostart: true
        }).connect(masterGain);
        audioInput = player;
    }
    
    // Create analyser
    analyser = new Tone.Analyser('waveform', 1024);
    audioInput.connect(analyser);
    
    // Get intervals
    let intervals = [];
    if (customIntervals.trim()) {
        intervals = customIntervals.split(',').map(Number).filter(n => !isNaN(n));
    } else {
        intervals = getPresetIntervals(preset);
    }
    
    // Create choir layers
    for (let o = 0; o < octaves; o++) {
        const layer = [];
        for (let v = 0; v < voices; v++) {
            const interval = intervals[v % intervals.length] + (o * 12);
            
            // Create pitch shift node
            const pitchShift = new Tone.PitchShift({
                pitch: interval,
                windowSize: 0.1,
                delayTime: 0.05
            });
            
            // Create panner for stereo width
            const pan = new Tone.Panner(((v / voices) * 2 - 1) * 0.7);
            
            // Create gain for volume control
            const gain = new Tone.Gain(0.5 / (octaves * voices));
            
            // Connect nodes
            audioInput.connect(pitchShift);
            pitchShift.connect(pan);
            pan.connect(gain);
            gain.connect(reverbNode);
            
            layer.push({
                pitchShift,
                pan,
                gain,
                interval,
                disconnect: () => {
                    pitchShift.dispose();
                    pan.dispose();
                    gain.dispose();
                }
            });
        }
        choirLayers.push(layer);
    }
    
    isChoirRunning = true;
    document.getElementById('startChoirBtn').disabled = true;
    document.getElementById('stopChoirBtn').disabled = false;
    document.getElementById('recordBtn').disabled = false;
    document.getElementById('previewBtn').disabled = false;
    
    document.getElementById('activeVoices').textContent = octaves * voices;
    document.getElementById('processingStatus').textContent = 'Active';
    document.getElementById('cpuLoad').textContent = '45%';
    
    showMessage('üéµ Choir processing started! Adjust settings in real-time.', 'success');
    
    // Start animation loop
    function animate() {
        if (!isChoirRunning) return;
        
        // Update CPU load simulation
        if (Math.random() > 0.7) {
            const load = 30 + Math.random() * 40;
            document.getElementById('cpuLoad').textContent = Math.round(load) + '%';
        }
        
        animationFrameId = requestAnimationFrame(animate);
    }
    
    animate();
});

// ======= STOP PROCESSING =======
document.getElementById('stopChoirBtn').addEventListener('click', function() {
    if (!isChoirRunning) return;
    
    isChoirRunning = false;
    if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
    }
    
    // Disconnect all audio nodes
    choirLayers.forEach(layer => {
        layer.forEach(voice => {
            voice.disconnect();
        });
    });
    choirLayers = [];
    
    if (audioInput) {
        if (audioInput.close) audioInput.close();
        audioInput.disconnect();
        audioInput = null;
    }
    
    document.getElementById('startChoirBtn').disabled = false;
    document.getElementById('stopChoirBtn').disabled = true;
    document.getElementById('activeVoices').textContent = '0';
    document.getElementById('processingStatus').textContent = 'Idle';
    document.getElementById('cpuLoad').textContent = '0%';
    
    showMessage('Choir processing stopped', 'warning');
});

// ======= PRESET FUNCTIONS =======
function getPresetIntervals(preset) {
    switch(preset) {
        case 'gospel': return [0, 4, 7, 10, 12, 14, 16];
        case 'cinematic': return [0, 2, 4, 7, 11, 12];
        case 'angelic': return [0, 5, 7, 12, 17, 19];
        case 'octaves': return [-12, 0, 12, 24];
        case 'unison': return [0, 0, 0, 0, 0, 0];
        default: return [0, 4, 7];
    }
}

// ======= UTILITY FUNCTIONS =======
function showMessage(text, type) {
    const messageEl = document.getElementById('uploadMessage');
    messageEl.textContent = text;
    messageEl.className = `message ${type}`;
    
    // Auto-hide success messages
    if (type === 'success') {
        setTimeout(() => {
            messageEl.style.display = 'none';
        }, 5000);
    } else {
        messageEl.style.display = 'block';
    }
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function updateStartButtonState() {
    const startBtn = document.getElementById('startChoirBtn');
    
    if (currentInputType === 'mic') {
        startBtn.disabled = !micStream;
    } else {
        startBtn.disabled = !audioBuffer;
    }
}

// ======= EXPORT FUNCTIONS =======
document.getElementById('recordBtn').addEventListener('click', async function() {
    if (!isChoirRunning) {
        showMessage('Start choir processing first', 'error');
        return;
    }
    
    try {
        const dest = Tone.context.createMediaStreamDestination();
        masterGain.connect(dest);
        
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(dest.stream);
        
        mediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) {
                recordedChunks.push(e.data);
            }
        };
        
        mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: 'audio/webm' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `cinematic_choir_${Date.now()}.wav`;
            a.click();
            
            showMessage('‚úÖ Recording downloaded!', 'success');
        };
        
        mediaRecorder.start();
        this.textContent = '‚è∫ Recording...';
        this.disabled = true;
        
        // Stop recording after 30 seconds
        setTimeout(() => {
            if (mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                this.textContent = '‚è∫ Record Live';
                this.disabled = false;
            }
        }, 30000);
        
    } catch (error) {
        showMessage(`Recording error: ${error.message}`, 'error');
    }
});

// Update system status every 5 seconds
setInterval(() => {
    document.getElementById('systemStatus').textContent = 'Ready';
}, 5000);
</script>
</body>
</html>
